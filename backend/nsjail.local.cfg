name: "sandbox_py"
mode: ONCE
hostname: "sandbox"
log_level: ERROR

# Sandbox config
cwd: "/tmp"

clone_newnet: true
clone_newuser: true
clone_newns: true
clone_newpid: true
clone_newipc: true
clone_newuts: true
clone_newcgroup: true

time_limit: 5
max_cpus: 1
rlimit_as: 256
rlimit_fsize: 10

envar: "HOME=/user"
envar: "LD_LIBRARY_PATH=/usr/local/lib"

# Required Python binary and libraries (original working set)
mount {
  src: "/usr/local/bin/python3"
  dst: "/usr/local/bin/python3"
  is_bind: true
  rw: false
}
mount {
  src: "/usr/local/lib/python3.11"
  dst: "/usr/local/lib/python3.11"
  is_bind: true
  rw: false
}
mount {
  src: "/usr/local/lib/python3.11/lib-dynload"
  dst: "/usr/local/lib/python3.11/lib-dynload"
  is_bind: true
  rw: false
}
mount {
  src: "/usr/local/lib/libpython3.11.so.1.0"
  dst: "/usr/local/lib/libpython3.11.so.1.0"
  is_bind: true
  rw: false
}
mount {
  src: "/lib/x86_64-linux-gnu/libc.so.6"
  dst: "/lib/x86_64-linux-gnu/libc.so.6"
  is_bind: true
  rw: false
}
mount {
  src: "/lib/x86_64-linux-gnu/libm.so.6"
  dst: "/lib/x86_64-linux-gnu/libm.so.6"
  is_bind: true
  rw: false
}
mount {
  src: "/lib64/ld-linux-x86-64.so.2"
  dst: "/lib64/ld-linux-x86-64.so.2"
  is_bind: true
  rw: false
}

# Add just the libraries we know we need, one by one
mount {
  src: "/usr/lib/x86_64-linux-gnu/libstdc++.so.6"
  dst: "/usr/lib/x86_64-linux-gnu/libstdc++.so.6"
  is_bind: true
  rw: false
}
mount {
  src: "/lib/x86_64-linux-gnu/libz.so.1"
  dst: "/lib/x86_64-linux-gnu/libz.so.1"
  is_bind: true
  rw: false
}
mount {
  src: "/lib/x86_64-linux-gnu/libgcc_s.so.1"
  dst: "/lib/x86_64-linux-gnu/libgcc_s.so.1"
  is_bind: true
  rw: false
}
mount {
  src: "/lib/x86_64-linux-gnu/libpthread.so.0"
  dst: "/lib/x86_64-linux-gnu/libpthread.so.0"
  is_bind: true
  rw: false
}
mount {
  src: "/usr/lib/x86_64-linux-gnu/libffi.so.8"
  dst: "/usr/lib/x86_64-linux-gnu/libffi.so.8"
  is_bind: true
  rw: false
}

# Sanitize /etc and /dev (original working version)
mount {
  src: "/etc"
  dst: "/etc"
  fstype: "tmpfs"
  rw: false
}
mount {
  src: "/dev/null"
  dst: "/dev/null"
  is_bind: true
  rw: false
}
mount {
  src: "/dev/urandom"
  dst: "/dev/urandom"
  is_bind: true
  rw: false
}

# Python packages
mount {
  src: "/usr/local/lib/python3.11/site-packages"
  dst: "/usr/local/lib/python3.11/site-packages"
  is_bind: true
  rw: false
}
mount {
  src: "/usr/local/lib/python3.11/dist-packages"
  dst: "/usr/local/lib/python3.11/dist-packages"
  is_bind: true
  rw: false
}

# Script bind
mount {
  src: "/tmp/script.py"
  dst: "/tmp/script.py"
  is_bind: true
  rw: true
}

# Execution binary and arguments
exec_bin {
  path: "/usr/local/bin/python3"
  arg: "python3"
  arg: "/tmp/script.py"
}